/**
 * Authentication Provider Component
 *
 * Provider global de autenticação para toda a aplicação.
 * Gerencia estado de login, persistência e sessão do usuário.
 *
 * Características:
 * - Autenticação mock local (admin/admin)
 * - Persistência em localStorage
 * - Restauração de sessão
 * - Hook useAuth() para componentes filhos
 * - Suporte a roles (manager/user)
 * - Estado de loading
 *
 * @fileoverview Authentication context provider
 * @author Rainer Teixeira
 * @version 1.0.0
 */

'use client';

// ============================================================================
// React
// ============================================================================

import {
  createContext,
  ReactNode,
  useContext,
  useEffect,
  useState,
} from 'react';

// ============================================================================
// Constants
// ============================================================================

/**
 * Chave do localStorage para dados do usuário
 */
const STORAGE_KEY_USER = 'auth_user' as const;

// ============================================================================
// Types
// ============================================================================

/**
 * Dados do usuário autenticado
 */
interface User {
  readonly id?: string;
  readonly cognitoSub?: string;
  readonly username?: string;
  readonly nickname?: string; // Nickname do Cognito
  readonly fullName?: string;
  readonly email?: string | undefined; // Explicitamente marcado como opcional
  readonly bio?: string;
  readonly avatar?: string;
  readonly website?: string;
  readonly role: 'manager' | 'user';
  readonly userCreateDate?: Date | string; // Data de criação do usuário no Cognito
}

/**
 * Tipo do contexto de autenticação
 */
interface AuthContextType {
  readonly user: User | null;
  readonly login: (username: string, password: string) => Promise<boolean>;
  readonly loginWithOAuthCode: (code: string) => Promise<boolean>;
  readonly logout: () => void;
  readonly isAuthenticated: boolean;
  readonly isLoading: boolean;
}

/**
 * Props do AuthProvider
 */
interface AuthProviderProps {
  readonly children: ReactNode;
}

// ============================================================================
// Context
// ============================================================================

const AuthContext = createContext<AuthContextType | undefined>(undefined);

// ============================================================================
// Custom Hook
// ============================================================================

/**
 * Custom hook para acesso ao contexto de autenticação
 *
 * Fornece acesso aos dados de autenticação e funções de login/logout.
 * Deve ser usado dentro de um AuthProvider.
 *
 * @returns Contexto de autenticação completo
 * @throws Error se usado fora do AuthProvider
 *
 * @example
 * ```tsx
 * function MyComponent() {
 *   const { user, isAuthenticated, logout } = useAuth()
 *   return <div>{user?.username}</div>
 * }
 * ```
 */
export function useAuth(): AuthContextType {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth deve ser usado dentro de AuthProvider');
  }
  return context;
}

// ============================================================================
// Main Component
// ============================================================================

/**
 * Authentication Provider
 *
 * Provedor de contexto de autenticação global.
 *
 * Funcionalidades:
 * - Login/logout de usuários
 * - Persistência de sessão em localStorage
 * - Restauração automática de sessão
 * - Estado de autenticação reativo
 *
 * Credenciais mock:
 * - Username: admin
 * - Password: admin
 *
 * @param children - Componentes filhos que terão acesso ao contexto
 * @returns Provider configurado
 *
 * @example
 * ```tsx
 * // No layout raiz
 * <AuthProvider>
 *   <App />
 * </AuthProvider>
 * ```
 */
export function AuthProvider({ children }: AuthProviderProps) {
  // ============================================================================
  // State
  // ============================================================================

  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [isLoadingAuth, setIsLoadingAuth] = useState(true);

  // ============================================================================
  // Effects
  // ============================================================================

  /**
   * Restaura sessão do localStorage ao montar
   */
  useEffect(() => {
    const restoreSession = async () => {
      try {
        const { authService, api } = await import('@/lib/api');

        if (authService.isAuthenticated()) {
          const accessToken = authService.getAccessToken();
          if (accessToken) {
            api.setAuthToken(accessToken);
            const userProfile = await authService.getUserProfile();

            // Separar dados por fonte:
            // - fullName vem do Prisma (banco de dados)
            // - username/nickname vêm do Cognito
            // - userCreateDate vem do Cognito
            const authenticatedUser: User = {
              id: userProfile.id || userProfile.cognitoSub,
              cognitoSub: userProfile.cognitoSub,
              // username e nickname vêm do Cognito (retornado pelo backend)
              username: (userProfile as any).username || undefined,
              nickname: (userProfile as any).nickname || undefined,
              // fullName vem do Prisma (banco de dados MongoDB)
              fullName: userProfile.fullName || undefined,
              email: (userProfile as any).email || undefined,
              bio: userProfile.bio,
              avatar: userProfile.avatar,
              website: userProfile.website,
              role: userProfile.role === 'ADMIN' ? 'manager' : 'user',
              // userCreateDate vem do Cognito
              userCreateDate: (userProfile as any).userCreateDate || undefined,
            };

            setCurrentUser(authenticatedUser);
            localStorage.setItem(
              STORAGE_KEY_USER,
              JSON.stringify(authenticatedUser)
            );
          }
        } else {
          authService.clearTokens();
          localStorage.removeItem(STORAGE_KEY_USER);
        }
      } catch (error) {
        console.error('Erro ao restaurar sessão:', error);
        localStorage.removeItem(STORAGE_KEY_USER);
      } finally {
        setIsLoadingAuth(false);
      }
    };

    restoreSession();
  }, []);

  // ============================================================================
  // Handler Functions
  // ============================================================================

  /**
   * Realiza login do usuário
   *
   * Valida credenciais via auth-local e salva sessão.
   * Suporta login com username ou email.
   *
   * @param username - Nome de usuário ou email
   * @param password - Senha do usuário
   * @returns Promise com sucesso/falha do login
   * @throws Error com mensagem de erro do backend
   */
  const handleLogin = async (
    username: string,
    password: string
  ): Promise<boolean> => {
    const { authService } = await import('@/lib/api');

    const loginResponse = await authService.login({
      email: username,
      password,
    });

    if (loginResponse.tokens && loginResponse.user) {
      authService.setTokens(loginResponse.tokens);

      const { api } = await import('@/lib/api');
      api.setAuthToken(loginResponse.tokens.accessToken);

      // Buscar perfil completo do usuário para obter o nickname do Cognito
      let userProfile: any = null;
      try {
        userProfile = await authService.getUserProfile();
      } catch (error) {
        console.warn('Erro ao buscar perfil completo após login:', error);
      }

      // Construir objeto User separando por fonte:
      // - fullName vem do Prisma (banco de dados)
      // - username/nickname vêm do Cognito
      // - userCreateDate vem do Cognito
      const authenticatedUser: User = {
        id: loginResponse.user.id || loginResponse.user.cognitoSub,
        cognitoSub: loginResponse.user.cognitoSub,
        // username e nickname vêm do Cognito (retornado pelo backend via userProfile)
        username:
          userProfile?.username ||
          (loginResponse.user as any).username ||
          undefined,
        nickname:
          userProfile?.nickname ||
          (loginResponse.user as any).nickname ||
          undefined,
        // fullName vem do Prisma (banco de dados MongoDB)
        fullName: userProfile?.fullName || loginResponse.user.fullName,
        ...((loginResponse.user as any).email
          ? { email: (loginResponse.user as any).email }
          : {}),
        bio: loginResponse.user.bio,
        avatar: loginResponse.user.avatar,
        website: loginResponse.user.website,
        role: loginResponse.user.role === 'ADMIN' ? 'manager' : 'user',
        // userCreateDate vem do Cognito
        userCreateDate: userProfile?.userCreateDate || undefined,
      };

      setCurrentUser(authenticatedUser);
      localStorage.setItem(STORAGE_KEY_USER, JSON.stringify(authenticatedUser));
      return true;
    }

    return false;
  };

  /**
   * Realiza login via OAuth (Google/GitHub)
   *
   * Troca o código OAuth por tokens e autentica o usuário
   */
  const handleLoginWithOAuthCode = async (code: string): Promise<boolean> => {
    try {
      const { authService, api } = await import('@/lib/api');

      // Trocar código por tokens
      const tokens = await authService.exchangeOAuthCode(code);

      // Configurar token na API
      api.setAuthToken(tokens.accessToken);

      // Buscar perfil do usuário
      let userProfile: any = null;
      try {
        userProfile = await authService.getUserProfile();
      } catch (error) {
        console.warn('Erro ao buscar perfil após login OAuth:', error);
      }

      // Construir objeto User
      const authenticatedUser: User = {
        id: userProfile?.id || userProfile?.cognitoSub,
        cognitoSub: userProfile?.cognitoSub,
        username: userProfile?.username,
        nickname: userProfile?.nickname,
        fullName: userProfile?.fullName,
        email: userProfile?.email,
        bio: userProfile?.bio,
        avatar: userProfile?.avatar,
        website: userProfile?.website,
        role: userProfile?.role === 'ADMIN' ? 'manager' : 'user',
        userCreateDate: userProfile?.userCreateDate,
      };

      setCurrentUser(authenticatedUser);
      localStorage.setItem(STORAGE_KEY_USER, JSON.stringify(authenticatedUser));
      return true;
    } catch (error) {
      console.error('Erro ao fazer login com OAuth:', error);
      return false;
    }
  };

  /**
   * Realiza logout do usuário
   *
   * Remove dados de sessão do estado e localStorage.
   */
  const handleLogout = async () => {
    try {
      const { authService, api } = await import('@/lib/api');
      authService.clearTokens();
      api.clearAuthToken();
      setCurrentUser(null);
      localStorage.removeItem(STORAGE_KEY_USER);
    } catch (error) {
      console.error('Erro ao realizar logout:', error);
    }
  };

  // ============================================================================
  // Context Value
  // ============================================================================

  const authContextValue: AuthContextType = {
    user: currentUser,
    login: handleLogin,
    loginWithOAuthCode: handleLoginWithOAuthCode,
    logout: handleLogout,
    isAuthenticated: !!currentUser,
    isLoading: isLoadingAuth,
  };

  // ============================================================================
  // Render
  // ============================================================================

  return (
    <AuthContext.Provider value={authContextValue}>
      {children}
    </AuthContext.Provider>
  );
}
