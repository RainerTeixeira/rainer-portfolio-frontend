# Guia de Testes de Autenticação via REST Client\n\nEste guia descreve como testar o fluxo de autenticação real (NestJS + Cognito) usando um REST client (Insomnia, Postman, VS Code REST, etc.).\n\n## 1. Pré-requisitos\n\n- Backend NestJS em execução (porta normalmente `3333`).\n- Variável `NEXT_PUBLIC_API_URL` apontando para a URL pública do backend (por exemplo, `http://localhost:3333`).\n- Usuário de teste cadastrado ou acesso a um fluxo de registro.\n\n## 2. Endpoints principais\n\n- `POST /auth/login` — login com email/senha.\n- `POST /auth/register` — registro de novo usuário.\n- `POST /auth/refresh` — refresh de token.\n- `POST /auth/logout` — logout/invalidação de refresh token.\n- `GET /auth/me` ou `GET /users/profile` (conforme backend) — obter perfil do usuário autenticado.\n\n> Observação: confirme a rota exata de perfil no backend (`/auth/me` ou `/users/profile`).\n\n## 3. Login com email e senha\n\n**Requisição**\n\n- Método: `POST`\n- URL: `${NEXT_PUBLIC_API_URL}/auth/login`\n- Body (JSON):\n\n```json\n{\n  "email": "seu-email@exemplo.com",\n  "password": "sua-senha"\n}\n```\n\n**Resposta esperada (exemplo genérico)**\n\n```json\n{\n  "success": true,\n  "data": {\n    "user": {\n      "id": "...",\n      "cognitoSub": "...",\n      "fullName": "Usuário Teste",\n      "email": "seu-email@exemplo.com",\n      "role": "AUTHOR"\n    },\n    "tokens": {\n      "accessToken": "...",\n      "refreshToken": "...",\n      "idToken": "..."\n    }\n  }\n}\n```\n\nGuarde os tokens (principalmente `accessToken` e `refreshToken`) para os próximos passos.\n\n## 4. Testar endpoint autenticado com Bearer Token\n\nDepois do login, use o `accessToken` em um endpoint protegido (ex.: `/users/profile`).\n\n- Método: `GET`\n- URL: `${NEXT_PUBLIC_API_URL}/users/profile` (ou `/auth/me`)\n- Header: `Authorization: Bearer <ACCESS_TOKEN>`\n\nVerifique se o backend retorna os dados do usuário autenticado.\n\n## 5. Refresh de token\n\n- Método: `POST`\n- URL: `${NEXT_PUBLIC_API_URL}/auth/refresh`\n- Body (JSON):\n\n```json\n{\n  "refreshToken": "<REFRESH_TOKEN>"\n}\n```\n\nA resposta deve trazer um novo par de tokens (`accessToken`/`idToken`), mantendo ou rotacionando o `refreshToken` conforme a implementação.\n\n## 6. Logout\n\n- Método: `POST`\n- URL: `${NEXT_PUBLIC_API_URL}/auth/logout`\n- Body (JSON), se aplicável: por exemplo,\n\n```json\n{\n  "refreshToken": "<REFRESH_TOKEN>"\n}\n```\n\nApós o logout, o refresh token não deve mais ser aceito pelo endpoint de refresh.\n\n## 7. Fluxo de "Esqueci minha senha"\n\n### 7.1. Iniciar reset de senha\n\n- Método: `POST`\n- URL: `${NEXT_PUBLIC_API_URL}/auth/forgot-password` ou `/auth/password/forgot`\n- Body (JSON):\n\n```json\n{\n  "email": "seu-email@exemplo.com"\n}\n```\n\nO backend deve enviar um código ou link de reset via email (Cognito).\n\n### 7.2. Confirmar reset de senha\n\n- Método: `POST`\n- URL: `${NEXT_PUBLIC_API_URL}/auth/reset-password` ou `/auth/password/reset`\n- Body (JSON) típico:\n\n```json\n{\n  "email": "seu-email@exemplo.com",\n  "code": "CODIGO_RECEBIDO",\n  "newPassword": "NovaSenha@123"\n}\n```\n\nApós sucesso, você deve conseguir fazer login com a nova senha.\n\n## 8. Login OAuth via backend\n\nO fluxo OAuth (Google/GitHub) normalmente envolve redirecionamento do navegador para o provedor, não apenas REST puro. Porém, alguns endpoints podem ser testados diretamente se o backend expuser um endpoint de troca de código OAuth.\n\nExemplo (ajuste para a implementação real):\n\n- Método: `POST`\n- URL: `${NEXT_PUBLIC_API_URL}/auth/oauth/exchange`\n- Body (JSON):\n\n```json\n{\n  "provider": "google",\n  "code": "CODIGO_OAUTH",\n  "redirectUri": "http://localhost:3000/dashboard/login/callback"\n}\n```\n\nA resposta deve conter os mesmos campos de `tokens` e `user` do login tradicional.\n\n## 9. Dicas de depuração\n\n- Verifique sempre se a URL usada no REST client é exatamente a mesma de `NEXT_PUBLIC_API_URL`.\n- Em desenvolvimento, o frontend pode chamar `/api/...` graças ao `rewrites` do Next.js, mas o REST client deve ir direto no backend (`http://localhost:3333`, por exemplo).\n- Erros comuns:\n  - 401/403: token ausente, inválido ou expirado.\n  - 400: payload inválido (campos faltando ou formato incorreto).\n  - 500: erro interno no backend; ver logs do NestJS.\n\n## 10. Relação com o frontend\n\nO frontend usa `authService` (em `lib/api/services/auth.service.ts`) e o hook `useAuth` para encapsular esse fluxo.\n\n- `authService.login` → `POST /auth/login`\n- `authService.register` → `POST /auth/register`\n- `authService.refreshToken` → `POST /auth/refresh`\n- `authService.logout` → `POST /auth/logout`\n- `authService.getUserProfile` → `GET /users/profile` ou `/auth/me`\n\nSe os testes via REST client estiverem funcionando, o frontend deve conseguir autenticar normalmente usando o mesmo backend.
